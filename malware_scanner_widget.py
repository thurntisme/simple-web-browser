"""
Malware Scanner Widget for Browser Mode
Provides a comprehensive malware scanning interface as a browser mode.
"""

import os
import threading
import tempfile
from datetime import datetime
from PyQt5.QtCore import *
from PyQt5.QtWidgets import *
from PyQt5.QtGui import *
from malware_scanner import MalwareScanner


class MalwareScannerWidget(QWidget):
    """Main widget for malware scanner browser mode"""
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.scanner = MalwareScanner()
        self.scan_thread = None
        self.setup_ui()
        self.connect_signals()
    
    def setup_ui(self):
        """Setup the user interface"""
        layout = QVBoxLayout(self)
        layout.setContentsMargins(20, 20, 20, 20)
        layout.setSpacing(15)
        
        # Header
        header_layout = QHBoxLayout()
        icon_label = QLabel("üõ°Ô∏è")
        icon_label.setStyleSheet("font-size: 32px;")
        
        title_label = QLabel("Malware Scanner")
        title_label.setStyleSheet("""
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin-left: 10px;
        """)
        
        header_layout.addWidget(icon_label)
        header_layout.addWidget(title_label)
        header_layout.addStretch()
        layout.addLayout(header_layout)
        
        # Description
        desc_label = QLabel("Comprehensive file scanning for malware detection using multiple analysis methods")
        desc_label.setStyleSheet("""
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
            margin-left: 42px;
        """)
        layout.addWidget(desc_label)
        
        # File selection
        file_group = QGroupBox("üìÅ File Selection")
        file_layout = QVBoxLayout(file_group)
        
        file_select_layout = QHBoxLayout()
        self.file_path_edit = QLineEdit()
        self.file_path_edit.setPlaceholderText("Select a file to scan for malware...")
        
        self.browse_btn = QPushButton("üìÇ Browse Files")
        self.browse_btn.clicked.connect(self.browse_file)
        
        file_select_layout.addWidget(self.file_path_edit)
        file_select_layout.addWidget(self.browse_btn)
        file_layout.addLayout(file_select_layout)
        
        layout.addWidget(file_group)
        
        # Scan controls
        controls_layout = QHBoxLayout()
        self.scan_btn = QPushButton("üîç Start Comprehensive Scan")
        self.scan_btn.clicked.connect(self.start_scan)
        
        self.stop_btn = QPushButton("‚èπÔ∏è Stop Scan")
        self.stop_btn.clicked.connect(self.stop_scan)
        self.stop_btn.setEnabled(False)
        
        controls_layout.addWidget(self.scan_btn)
        controls_layout.addWidget(self.stop_btn)
        controls_layout.addStretch()
        layout.addLayout(controls_layout)
        
        # Progress
        progress_group = QGroupBox("üìä Scan Progress")
        progress_layout = QVBoxLayout(progress_group)
        
        self.progress_bar = QProgressBar()
        self.status_label = QLabel("Ready to scan - Select a file and click 'Start Comprehensive Scan'")
        
        progress_layout.addWidget(self.progress_bar)
        progress_layout.addWidget(self.status_label)
        layout.addWidget(progress_group)
        
        # Results
        results_group = QGroupBox("üìã Scan Results")
        results_layout = QVBoxLayout(results_group)
        
        self.results_tabs = QTabWidget()
        
        # Summary tab
        self.summary_tab = QWidget()
        summary_layout = QVBoxLayout(self.summary_tab)
        self.summary_text = QTextEdit()
        self.summary_text.setReadOnly(True)
        summary_layout.addWidget(self.summary_text)
        self.results_tabs.addTab(self.summary_tab, "üìä Summary")
        
        # Threats tab
        self.threats_tab = QWidget()
        threats_layout = QVBoxLayout(self.threats_tab)
        self.threats_list = QListWidget()
        threats_layout.addWidget(self.threats_list)
        self.results_tabs.addTab(self.threats_tab, "‚ö†Ô∏è Threats")
        
        # Details tab
        self.details_tab = QWidget()
        details_layout = QVBoxLayout(self.details_tab)
        self.details_text = QTextEdit()
        self.details_text.setReadOnly(True)
        details_layout.addWidget(self.details_text)
        self.results_tabs.addTab(self.details_tab, "üîç Details")
        
        results_layout.addWidget(self.results_tabs)
        layout.addWidget(results_group)
        
        # Action buttons
        button_layout = QHBoxLayout()
        self.export_btn = QPushButton("üíæ Export Results")
        self.export_btn.clicked.connect(self.export_results)
        self.export_btn.setEnabled(False)
        
        self.clear_btn = QPushButton("üóëÔ∏è Clear Results")
        self.clear_btn.clicked.connect(self.clear_results)
        
        button_layout.addWidget(self.export_btn)
        button_layout.addWidget(self.clear_btn)
        button_layout.addStretch()
        layout.addLayout(button_layout)
        
        # Store results for export
        self.last_results = None
    
    def connect_signals(self):
        """Connect scanner signals"""
        self.scanner.scan_progress.connect(self.update_progress)
        self.scanner.scan_status.connect(self.update_status)
        self.scanner.scan_complete.connect(self.display_results)
    
    def browse_file(self):
        """Browse for file to scan"""
        file_path, _ = QFileDialog.getOpenFileName(
            self,
            "Select File to Scan for Malware",
            "",
            "All Files (*.*)"
        )
        if file_path:
            self.file_path_edit.setText(file_path)
    
    def start_scan(self):
        """Start malware scan"""
        file_path = self.file_path_edit.text().strip()
        if not file_path:
            QMessageBox.warning(self, "No File Selected", "Please select a file to scan.")
            return
        
        if not os.path.exists(file_path):
            QMessageBox.warning(self, "File Not Found", "The selected file does not exist.")
            return
        
        # Reset UI
        self.progress_bar.setValue(0)
        self.status_label.setText("Initializing comprehensive malware scan...")
        self.scan_btn.setEnabled(False)
        self.stop_btn.setEnabled(True)
        self.export_btn.setEnabled(False)
        
        # Clear previous results
        self.clear_results()
        
        # Start scan in thread
        self.scan_thread = threading.Thread(
            target=lambda: self.scanner.scan_complete.emit(self.scanner.scan_file(file_path))
        )
        self.scan_thread.daemon = True
        self.scan_thread.start()
    
    def stop_scan(self):
        """Stop current scan"""
        self.scanner.stop_scan()
        self.scan_btn.setEnabled(True)
        self.stop_btn.setEnabled(False)
        self.status_label.setText("Scan stopped by user")
    
    def update_progress(self, value):
        """Update progress bar"""
        self.progress_bar.setValue(value)
    
    def update_status(self, message):
        """Update status label"""
        self.status_label.setText(message)
    
    def display_results(self, results):
        """Display scan results"""
        self.last_results = results
        self.scan_btn.setEnabled(True)
        self.stop_btn.setEnabled(False)
        self.export_btn.setEnabled(True)
        
        # Display summary
        self.display_summary(results)
        
        # Display threats
        self.display_threats(results)
        
        # Display details
        self.display_details(results)
        
        # Set appropriate tab based on results
        if results.get('threats_found'):
            self.results_tabs.setCurrentIndex(1)  # Threats tab
        else:
            self.results_tabs.setCurrentIndex(0)  # Summary tab
    
    def display_summary(self, results):
        """Display summary in summary tab"""
        threat_level = results.get('threat_level', 'unknown')
        threats_count = len(results.get('threats_found', []))
        
        summary_text = f"""
        Malware Scan Results
        ====================
        
        File: {results.get('file_name', 'N/A')}
        Path: {results.get('file_path', 'N/A')}
        Size: {results.get('file_info', {}).get('size_human', 'N/A')}
        Type: {results.get('file_info', {}).get('mime_type', 'N/A')}
        
        Threat Level: {threat_level.upper()}
        Threats Found: {threats_count}
        Scan Methods: {', '.join(results.get('scan_methods', []))}
        
        Recommendations:
        """
        
        for rec in results.get('recommendations', []):
            summary_text += f"‚Ä¢ {rec}\n"
        
        self.summary_text.setPlainText(summary_text)
    
    def display_threats(self, results):
        """Display threats in threats tab"""
        self.threats_list.clear()
        
        for threat in results.get('threats_found', []):
            description = threat.get('description', 'Unknown threat')
            severity = threat.get('severity', 'unknown')
            
            item_text = f"[{severity.upper()}] {description}"
            item = QListWidgetItem(item_text)
            
            # Set color based on severity
            if severity == 'high':
                item.setForeground(QColor("#e74c3c"))
            elif severity == 'medium':
                item.setForeground(QColor("#f39c12"))
            else:
                item.setForeground(QColor("#3498db"))
            
            self.threats_list.addItem(item)
        
        if not results.get('threats_found'):
            item = QListWidgetItem("‚úÖ No threats detected - File appears to be clean")
            item.setForeground(QColor("#27ae60"))
            self.threats_list.addItem(item)
    
    def display_details(self, results):
        """Display detailed results in details tab"""
        import json
        details_json = json.dumps(results, indent=2, default=str)
        self.details_text.setPlainText(details_json)
    
    def export_results(self):
        """Export scan results to file"""
        if not self.last_results:
            QMessageBox.information(self, "No Results", "No scan results to export.")
            return
        
        file_path, _ = QFileDialog.getSaveFileName(
            self,
            "Export Malware Scan Results",
            f"malware_scan_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json",
            "JSON Files (*.json);;All Files (*.*)"
        )
        
        if file_path:
            try:
                import json
                with open(file_path, 'w') as f:
                    json.dump(self.last_results, f, indent=2, default=str)
                
                QMessageBox.information(
                    self,
                    "Export Successful",
                    f"Scan results exported successfully!\n\nFile saved to:\n{file_path}"
                )
            except Exception as e:
                QMessageBox.critical(
                    self,
                    "Export Failed",
                    f"Failed to export scan results:\n\n{str(e)}"
                )
    
    def clear_results(self):
        """Clear all results"""
        self.summary_text.clear()
        self.threats_list.clear()
        self.details_text.clear()
        self.last_results = None
        self.export_btn.setEnabled(False)


if __name__ == "__main__":
    # Test the malware scanner widget
    import sys
    from PyQt5.QtWidgets import QApplication
    
    app = QApplication(sys.argv)
    widget = MalwareScannerWidget()
    widget.show()
    sys.exit(app.exec_())